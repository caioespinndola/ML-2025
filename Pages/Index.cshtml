@page
@model IndexModel
@{
    ViewData["Title"] = "Seu Dashboard de Estilo";
}

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-primary">👗 Bem-vindo ao seu IA Closet</h1>
        <p class="lead text-muted">Seu assistente de estilo pessoal, pronto para te ajudar a brilhar.</p>
    </div>

   
    <div class="row justify-content-center">
        <div class="col-lg-8 d-flex">

            <
            <div class="chat-container shadow-lg">
                <div class="chat-history" id="chat-history">
                    <div class="chat-bubble ai">
                        Olá! Descreva seu look e eu te ajudo a analisar.
                    </div>
                </div>

                <form class="chat-input-area" id="form-analise-texto">
                    <input type="text" id="input-analise-texto" class="chat-input-bar" placeholder="Ex: Calça de alfaiataria bege e camisa de linho...">
                    <button type="submit" id="btn-analisar-texto" class="chat-send-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none" /><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" /></svg>
                    </button>
                </form>

            </div>
        </div>
    </div>
    

</div>


@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {

            const chatHistory = document.getElementById("chat-history");
            const formAnalise = document.getElementById("form-analise-texto");
            const inputTexto = document.getElementById("input-analise-texto");
            const btnAnalise = document.getElementById("btn-analisar-texto");


            let lastUserPrompt = "";


            formAnalise.addEventListener("submit", async function(e) {
                e.preventDefault();
                const userText = inputTexto.value.trim();
                if (userText === "") return;


                lastUserPrompt = userText;

                appendBubble(userText, 'user');
                inputTexto.value = "";
                btnAnalise.disabled = true;


                await getAiResponse(userText);

                btnAnalise.disabled = false;
                inputTexto.focus();
            });


            async function getAiResponse(prompt) {
                appendLoader();

                const dados = { text: prompt };

                try {
                    const response = await fetch("/predict", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(dados)
                    });

                    if (!response.ok) {
                        throw new Error("Erro na rede: " + response.statusText);
                    }

                    const prediction = await response.json();


                    const aiResponseHtml = formatAiResponse(prediction);

                    removeLoader();

                    
                    if (prompt === lastUserPrompt) {
                        const previousAiBubbles = chatHistory.querySelectorAll('.chat-bubble.ai:not(#loader)');
                        if (previousAiBubbles.length > 0) {
                            
                            previousAiBubbles[previousAiBubbles.length - 1].remove();
                        }
                    }

                    appendBubble(aiResponseHtml, 'ai', prompt);

                } catch (error) {
                    console.error("Falha ao analisar:", error);
                    removeLoader();
                    appendBubble("Ops! Algo deu errado. Tente novamente.", 'ai');
                }
            }



            function appendBubble(content, type, userQuestionContext = null) {
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', type);
                bubble.innerHTML = content;
                chatHistory.appendChild(bubble);


                if (type === 'ai' && userQuestionContext) {

                    
                    const responseHtmlForLog = bubble.querySelector('.ai-response-content') ? bubble.querySelector('.ai-response-content').innerHTML : content;
                    addBubbleListeners(bubble, userQuestionContext, responseHtmlForLog);
                }

                scrollToBottom();
            }


            function appendLoader() {
                const loaderHtml = `
                    <div class="chat-bubble ai loading" id="loader">
                        <div class="gemini-loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    </div>
                `;
                
                if (!document.getElementById("loader")) {
                    chatHistory.innerHTML += loaderHtml;
                    scrollToBottom();
                }
            }


            function removeLoader() {
                const loader = document.getElementById("loader");
                if (loader) loader.remove();
            }


            function formatAiResponse(prediction) {
                const isStylish = prediction.predictedLabel;
                const title = isStylish ? "Look Aprovado! 😎" : "Ponto de Atenção! 🤔";
                const probability = (prediction.probability * 100).toFixed(1) + "%";
                const suggestion = prediction.suggestion || (isStylish ? "Você arrasou na combinação!" : "Que tal tentar alguns ajustes?");

                
                return `
                    <div class="ai-response-content">
                        <h4 style="margin-top:0; margin-bottom: 10px;">${title}</h4>
                        <p style="margin-bottom: 12px;">${suggestion}</p>
                        <small style="opacity: 0.7;">Confiança do modelo: ${probability}</small>
                    </div>
                    <div class="feedback-actions">
                        <button class="feedback-btn thumb-up" title="Gostei desta resposta">👍</button>
                        <button class="feedback-btn thumb-down" title="Não gostei desta resposta">👎</button>
                        <button class="feedback-btn regenerate" title="Gerar outra resposta">🔄</button>
                    </div>
                `;
            }


          function addBubbleListeners(bubble, pergunta, respostaHtml) {
                const btnThumbUp = bubble.querySelector('.thumb-up');
                const btnThumbDown = bubble.querySelector('.thumb-down');
                const btnRegenerate = bubble.querySelector('.regenerate');

                
                if (!btnRegenerate) return;

                const allButtons = [btnThumbUp, btnThumbDown, btnRegenerate];


                function disableButtons() {
                    allButtons.forEach(btn => {
                        
                        if (btn) btn.disabled = true;
                    });
                }


                btnThumbUp.addEventListener('click', async () => {
                    disableButtons();
                    btnThumbUp.classList.add('selected');

                    appendBubble("Que bom que gostou! Seu feedback positivo nos ajuda a aprender. 😊", 'ai', null);

                    try {
                        await fetch('/log-feedback', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                Pergunta: pergunta,
                                RespostaHtml: respostaHtml
                            })
                        });
                        console.log("Feedback útil registrado!");
                    } catch (error) {
                        console.error("Falha ao registrar feedback:", error);
                    }
                });


                btnThumbDown.addEventListener('click', () => {
                    disableButtons();
                    btnThumbDown.classList.add('selected');

                    appendBubble("Agradecemos seu feedback. Isso nos motiva a melhorar! 📝", 'ai', null);
                });


                btnRegenerate.addEventListener('click', async () => {
                    console.log("Regerando resposta para:", lastUserPrompt);

                    
                    disableButtons();
                    btnAnalise.disabled = true;

                    
                    bubble.remove();

                    
                    await getAiResponse(lastUserPrompt);

                    btnAnalise.disabled = false;
                    inputTexto.focus();
                });
            }


            function scrollToBottom() {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }


            inputTexto.focus();
        });
    </script>
}