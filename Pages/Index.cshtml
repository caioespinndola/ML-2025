@page
@model IndexModel
@{
    ViewData["Title"] = "Seu Dashboard de Estilo";
}

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-primary">👗 Bem-vindo ao seu IA Closet</h1>
        <p class="lead text-muted">Seu assistente de estilo pessoal, pronto para te ajudar a brilhar.</p>
    </div>

    <!-- MUDANÇA DE LAYOUT:
         Removemos a 'row g-5' e substituímos por uma
         linha centralizada com 8 colunas para o chat.
    -->
    <div class="row justify-content-center">
        <div class="col-lg-8 d-flex">

            <!-- O HTML do Chat Container não muda -->
            <div class="chat-container shadow-lg">
                <div class="chat-history" id="chat-history">
                    <div class="chat-bubble ai">
                        Olá! Descreva seu look e eu te ajudo a analisar.
                    </div>
                </div>

                <form class="chat-input-area" id="form-analise-texto">
                    <input type="text" id="input-analise-texto" class="chat-input-bar" placeholder="Ex: Calça de alfaiataria bege e camisa de linho...">
                    <button type="submit" id="btn-analisar-texto" class="chat-send-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none" /><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" /></svg>
                    </button>
                </form>

            </div>
        </div>
    </div>
    <!-- FIM DA MUDANÇA DE LAYOUT -->

</div>

<!-- ======================================================= -->
<!-- JAVASCRIPT ATUALIZADO (com Feedback e Regenerate)     -->
<!-- ======================================================= -->
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {

            const chatHistory = document.getElementById("chat-history");
            const formAnalise = document.getElementById("form-analise-texto");
            const inputTexto = document.getElementById("input-analise-texto");
            const btnAnalise = document.getElementById("btn-analisar-texto");

            // Variável para guardar a última pergunta do usuário
            let lastUserPrompt = "";

            // --- Lógica de Envio do Chat ---
            formAnalise.addEventListener("submit", async function(e) {
                e.preventDefault();
                const userText = inputTexto.value.trim();
                if (userText === "") return;

                // Salva a pergunta do usuário para a função "Regenerate"
                lastUserPrompt = userText;

                appendBubble(userText, 'user');
                inputTexto.value = "";
                btnAnalise.disabled = true;

                // Chama a função principal de chat
                await getAiResponse(userText);

                btnAnalise.disabled = false;
                inputTexto.focus();
            });

            // --- Função Principal para buscar Resposta da IA ---
            async function getAiResponse(prompt) {
                appendLoader();

                const dados = { text: prompt };

                try {
                    const response = await fetch("/predict", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(dados)
                    });

                    if (!response.ok) {
                        throw new Error("Erro na rede: " + response.statusText);
                    }

                    const prediction = await response.json();

                    // Formata a resposta da IA (com os novos botões)
                    const aiResponseHtml = formatAiResponse(prediction);

                    removeLoader();
                    // Passa o prompt (pergunta) para a função de feedback saber o contexto
                    appendBubble(aiResponseHtml, 'ai', prompt);

                } catch (error) {
                    console.error("Falha ao analisar:", error);
                    removeLoader();
                    appendBubble("Ops! Algo deu errado. Tente novamente.", 'ai');
                }
            }


            // --- Funções Auxiliares ---

            // Função para adicionar um balão de chat
            function appendBubble(content, type, userQuestionContext = null) {
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', type);
                bubble.innerHTML = content;
                chatHistory.appendChild(bubble);

                // Se for um balão da IA, adiciona os 'escutadores' de feedback
                if (type === 'ai' && userQuestionContext) {
                    // Passa o HTML da resposta para salvar no log de feedback
                    const responseHtmlForLog = bubble.querySelector('.ai-response-content').innerHTML;
                    addBubbleListeners(bubble, userQuestionContext, responseHtmlForLog);
                }

                scrollToBottom();
            }

            // Função para adicionar o loader
            function appendLoader() {
                const loaderHtml = `
                    <div class="chat-bubble ai loading" id="loader">
                        <div class="gemini-loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    </div>
                `;
                chatHistory.innerHTML += loaderHtml;
                scrollToBottom();
            }

            // Função para remover o loader
            function removeLoader() {
                const loader = document.getElementById("loader");
                if (loader) loader.remove();
            }

            // Função para formatar a resposta da IA (COM NOVOS BOTÕES)
            function formatAiResponse(prediction) {
                const isStylish = prediction.predictedLabel;
                const title = isStylish ? "Look Aprovado! 😎" : "Ponto de Atenção! 🤔";
                const probability = (prediction.probability * 100).toFixed(1) + "%";
                const suggestion = prediction.suggestion || (isStylish ? "Você arrasou na combinação!" : "Que tal tentar alguns ajustes?");

                // Retorna o HTML formatado com os 3 botões
                return `
                    <!-- Este div extra ajuda a pegar o HTML para o log de feedback -->
                    <div class="ai-response-content">
                        <h4 style="margin-top:0; margin-bottom: 10px;">${title}</h4>
                        <p style="margin-bottom: 12px;">${suggestion}</p>
                        <small style="opacity: 0.7;">Confiança do modelo: ${probability}</small>
                    </div>
                    <div class="feedback-actions">
                        <button class="feedback-btn thumb-up" title="Gostei desta resposta">👍</button>
                        <button class="feedback-btn thumb-down" title="Não gostei desta resposta">👎</button>
                        <button class="feedback-btn regenerate" title="Gerar outra resposta">🔄</button>
                    </div>
                `;
            }

            // NOVIDADE: Função para adicionar 'escutas' nos 3 botões
            function addBubbleListeners(bubble, pergunta, respostaHtml) {
                const btnThumbUp = bubble.querySelector('.thumb-up');
                const btnThumbDown = bubble.querySelector('.thumb-down');
                const btnRegenerate = bubble.querySelector('.regenerate');

                // Ação para "Gostei" (👍)
                btnThumbUp.addEventListener('click', async () => {
                    btnThumbUp.classList.add('selected');
                    btnThumbDown.disabled = true;
                    btnThumbUp.disabled = true;
                    btnRegenerate.disabled = true; // Desabilita todos

                    // CHAMA A API DE FEEDBACK
                    try {
                        await fetch('/log-feedback', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                Pergunta: pergunta,
                                RespostaHtml: respostaHtml // Salva o HTML limpo da resposta
                            })
                        });
                        console.log("Feedback útil registrado!");
                    } catch (error) {
                        console.error("Falha ao registrar feedback:", error);
                    }
                });

                // Ação para "Não Gostei" (👎)
                btnThumbDown.addEventListener('click', () => {
                    btnThumbDown.classList.add('selected');
                    btnThumbDown.disabled = true;
                    btnThumbUp.disabled = true;
                    btnRegenerate.disabled = true;
                });

                // NOVIDADE: Ação para "Regerar Resposta" (🔄)
                btnRegenerate.addEventListener('click', async () => {
                    console.log("Regerando resposta para:", lastUserPrompt);

                    // Desabilita os botões do balão ATUAL
                    btnThumbDown.disabled = true;
                    btnThumbUp.disabled = true;
                    btnRegenerate.disabled = true;

                    // Chama a IA novamente com a ÚLTIMA pergunta
                    await getAiResponse(lastUserPrompt);
                });
            }

            // Função para rolar o chat para o final
            function scrollToBottom() {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            // Foco no input ao carregar
            inputTexto.focus();
        });
    </script>
}