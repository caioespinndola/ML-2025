@page
@model IndexModel
@{
    ViewData["Title"] = "Seu Dashboard de Estilo";
}

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-primary">👗 Bem-vindo ao seu IA Closet</h1>
        <p class="lead text-muted">Seu assistente de estilo pessoal, pronto para te ajudar a brilhar.</p>
    </div>

    <div class="row g-5">

        <div class="col-lg-6 d-flex">
            <div class="chat-container shadow-lg">

                <div class="chat-history" id="chat-history">
                    <div class="chat-bubble ai">
                        Olá! Descreva seu look e eu te ajudo a analisar.
                    </div>
                </div>

                <form class="chat-input-area" id="form-analise-texto">
                    <input type="text" id="input-analise-texto" class="chat-input-bar" placeholder="Ex: Calça de alfaiataria bege e camisa de linho...">

                    <button type="submit" id="btn-analisar-texto" class="chat-send-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none" /><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" /></svg>
                    </button>
                </form>

            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-lg border-0 rounded-3 mb-4">
                <div class="card-body p-4 text-center">
                    <h4 class="card-title mb-3">☀️ Look do Dia</h4>
                    <p class="text-muted">Com base no clima de hoje (24°C, Ensolarado) e nas suas peças, sugerimos:</p>
                    <div class="d-flex justify-content-center gap-3 my-3">
                        <img src="/images/pecas/camisa-linho.jpg" class="rounded shadow-sm" width="100" alt="Camisa de linho">
                        <img src="/images/pecas/calca-bege.jpg" class="rounded shadow-sm" width="100" alt="Calça bege">
                        <img src="/images/pecas/sandalia-couro.jpg" class="rounded shadow-sm" width="100" alt="Sandália de couro">
                    </div>
                    <a href="/MontadorDeLooks" class="btn btn-outline-primary">Ver outras combinações</a>
                </div>
            </div>

            <div class="card shadow-lg border-0 rounded-3">
                <div class="card-body p-4 text-center">
                    <h4 class="card-title mb-3">Meu Guarda-Roupa</h4>
                    <p class="lead">Você tem <strong>87 peças</strong> catalogadas.</p>
                    <p class="text-muted">Adicione suas roupas para receber sugestões personalizadas e inteligentes.</p>
                    <a href="/MeuGuardaRoupa" class="btn btn-primary fw-bold">Acessar Meu Guarda-Roupa</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {

            // Pega os novos elementos do chat
            const chatHistory = document.getElementById("chat-history");
            const formAnalise = document.getElementById("form-analise-texto");
            const inputTexto = document.getElementById("input-analise-texto");
            const btnAnalise = document.getElementById("btn-analisar-texto");

            // --- Lógica de Envio do Chat ---
            formAnalise.addEventListener("submit", async function(e) {
                e.preventDefault(); // Impede o recarregamento da página

                const userText = inputTexto.value.trim();
                if (userText === "") return; // Não envia se estiver vazio

                // 1. Adiciona o balão do usuário
                appendBubble(userText, 'user');
                inputTexto.value = ""; // Limpa o input
                btnAnalise.disabled = true;

                // 2. Adiciona o "digitando..." (loader)
                appendLoader();

                // 3. Prepara e envia os dados para a API
                const dados = { text: userText };

                try {
                    const response = await fetch("/predict", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(dados)
                    });

                    if (!response.ok) {
                        throw new Error("Erro na rede: " + response.statusText);
                    }

                    const prediction = await response.json();

                    // 4. Formata a resposta da IA
                    const aiResponseHtml = formatAiResponse(prediction);

                    // 5. Remove o loader e adiciona a resposta da IA
                    removeLoader();
                    appendBubble(aiResponseHtml, 'ai');

                } catch (error) {
                    console.error("Falha ao analisar:", error);
                    removeLoader();
                    appendBubble("Ops! Algo deu errado ao tentar analisar. Tente novamente.", 'ai');
                } finally {
                    btnAnalise.disabled = false;
                }
            });

            // --- Funções Auxiliares ---

            // Função para adicionar um balão de chat
            function appendBubble(content, type) {
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', type);
                bubble.innerHTML = content; // Usamos innerHTML para renderizar o HTML da resposta
                chatHistory.appendChild(bubble);
                scrollToBottom();
            }

            // Função para adicionar o loader
            function appendLoader() {
                const loaderHtml = `
                    <div class="chat-bubble ai loading" id="loader">
                        <div class="gemini-loader">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    </div>
                `;
                chatHistory.innerHTML += loaderHtml;
                scrollToBottom();
            }

            // Função para remover o loader
            function removeLoader() {
                const loader = document.getElementById("loader");
                if (loader) {
                    loader.remove();
                }
            }

            // Função para formatar a resposta da IA (vinda do JSON)
            function formatAiResponse(prediction) {
                const isStylish = prediction.predictedLabel;
                const title = isStylish ? "Look Aprovado! 😎" : "Ponto de Atenção! 🤔";
                const probability = (prediction.probability * 100).toFixed(1) + "%";
                // IMPORTANTE: Seu JSON de resposta precisa ter a propriedade "suggestion"
                const suggestion = prediction.suggestion || (isStylish ? "Você arrasou na combinação!" : "Que tal tentar alguns ajustes?");

                // Retorna o HTML formatado para o balão da IA
                return `
                    <h4 style="margin-top:0; margin-bottom: 10px;">${title}</h4>
                    <p style="margin-bottom: 12px;">${suggestion}</p>
                    <small style="opacity: 0.7;">Confiança do modelo: ${probability}</small>
                `;
            }

            // Função para rolar o chat para o final
            function scrollToBottom() {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        });
    </script>
}